services:
  # ============================================================================
  # PostgreSQL Database Service
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: xrpl-impact-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-xrpl_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-xrpl_password}
      POSTGRES_DB: ${POSTGRES_DB:-xrpl_impact_fund}
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/src/config/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-xrpl_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - xrpl-network

  # ============================================================================
  # Redis Cache Service
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: xrpl-impact-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - xrpl-network

  # ============================================================================
  # Backend API Service
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: xrpl-impact-backend
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # XRPL Configuration
      XRPL_NETWORK: ${XRPL_NETWORK:-mock}
      XRPL_WEBSOCKET_URL: ${XRPL_WEBSOCKET_URL}
      XRPL_POOL_WALLET_SEED: ${XRPL_POOL_WALLET_SEED}
      XRPL_POOL_WALLET_ADDRESS: ${XRPL_POOL_WALLET_ADDRESS}

      # Server
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-development}
      API_BASE_URL: ${API_BASE_URL:-http://localhost:3000}

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-xrpl_user}:${POSTGRES_PASSWORD:-xrpl_password}@postgres:5432/${POSTGRES_DB:-xrpl_impact_fund}
      DATABASE_ENABLED: ${DATABASE_ENABLED:-false}

      # Redis
      REDIS_URL: redis://redis:6379
      REDIS_ENABLED: ${REDIS_ENABLED:-false}

      # AI Trading
      AI_TRADING_ENABLED: ${AI_TRADING_ENABLED:-true}
      AI_TRADING_INTERVAL_HOURS: ${AI_TRADING_INTERVAL_HOURS:-24}
      AI_MAX_POSITION_SIZE: ${AI_MAX_POSITION_SIZE:-0.10}
      AI_RISK_TOLERANCE: ${AI_RISK_TOLERANCE:-conservative}

      # Security
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}

      # Demo Mode
      DEMO_MODE: ${DEMO_MODE:-true}
      AUTO_SEED_NGOS: ${AUTO_SEED_NGOS:-true}
      AUTO_SEED_DONORS: ${AUTO_SEED_DONORS:-false}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_CONSOLE: true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend/src:/app/src
      - backend_logs:/app/logs
    networks:
      - xrpl-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/xrpl/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # ImpactOracle Micro-service
  # ============================================================================
  impact-oracle:
    build:
      context: ./backend/services/impact-oracle
      dockerfile: Dockerfile
    container_name: xrpl-impact-oracle
    restart: unless-stopped
    ports:
      - "${ORACLE_PORT:-3300}:3300"
    environment:
      PORT: 3300
      NODE_ENV: ${NODE_ENV:-development}
    networks:
      - xrpl-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3300/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - oracle_logs:/var/log/oracle

  # ============================================================================
  # Frontend Service
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: xrpl-impact-frontend
    restart: unless-stopped
    ports:
      - "${VITE_PORT:-5173}:5173"
    environment:
      VITE_API_URL: http://backend:3000
      VITE_XRPL_NETWORK: ${VITE_XRPL_NETWORK:-mock}
      VITE_ENABLE_ANALYTICS: ${VITE_ENABLE_ANALYTICS:-false}
      VITE_REFRESH_INTERVAL: ${VITE_REFRESH_INTERVAL:-5000}
    depends_on:
      - backend
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    networks:
      - xrpl-network
    command: npm run dev -- --host 0.0.0.0

# ============================================================================
# Persistent Volumes
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backend_logs:
    driver: local
  oracle_logs:
    driver: local

# ============================================================================
# Network Configuration
# ============================================================================
networks:
  xrpl-network:
    driver: bridge

